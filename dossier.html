<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enval – Dossier</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .statusbar { display:flex; gap:12px; align-items:center; justify-content:space-between; }
      .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:600; font-size:0.85rem; border:1px solid #cbd5e1; background:#fff; }
      .pill.ok { border-color:#22c55e; }
      .pill.warn { border-color:#f59e0b; }
      .pill.err { border-color:#ef4444; }
      .muted { color:#64748b; }
      .grid2 { display:grid; gap:16px; }
      @media (min-width:768px){ .grid2 { grid-template-columns: 1fr 1fr; } }
      .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
      .table { width:100%; border-collapse:collapse; }
      .table th, .table td { border-bottom:1px solid #e2e8f0; padding:10px 6px; text-align:left; font-size:0.95rem; }
      .table th { font-size:0.85rem; color:#64748b; font-weight:600; }
      .right { text-align:right; }
      .small { font-size:0.85rem; }
      .hidden { display:none !important; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>

  <body>
    <header>
      <div class="container header-inner">
        <div class="logo"><a href="/index.html">Enval</a></div>
        <nav>
          <a href="/index.html">Home</a>
          <a href="/hoe-het-werkt.html">Hoe het werkt</a>
          <a href="/regelgeving.html">Regelgeving</a>
          <a href="/index.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="section">
        <div class="container">
          <div class="card">
            <div class="statusbar">
              <div>
                <h1 style="margin:0 0 6px 0;">Jouw Enval dossier</h1>
                <div class="muted small">
                  Dossier: <span id="dossierId" class="mono">-</span>
                </div>
              </div>
              <div class="row">
                <span id="statusPill" class="pill">laden…</span>
                <button id="btnRefresh" class="btn outline" type="button">Ververs</button>
              </div>
            </div>

            <div style="margin-top:14px;">
              <div class="muted">
                Vul onderstaande stappen in. Na elke stap herberekenen we automatisch de dossierstatus.
              </div>
            </div>
          </div>

          <div class="grid2" style="margin-top:18px;">
            <!-- EMAIL VERIFY -->
            <div class="card">
              <h2 style="margin-top:0;">1) E-mail bevestigen</h2>
              <div id="emailState" class="muted">laden…</div>
              <div class="row" style="margin-top:10px;">
                <button id="btnEmailVerifyStart" class="btn outline" type="button">Stuur bevestigingsmail</button>
              </div>
              <div class="small muted" style="margin-top:10px;">
                Als je via de bevestigingslink terugkomt, wordt je e-mail hier automatisch bevestigd.
              </div>
            </div>

            <!-- ADDRESS -->
            <div class="card">
              <h2 style="margin-top:0;">2) Adres</h2>

              <form id="addressForm" class="form" novalidate>
                <label>
                  <span>Postcode</span>
                  <input type="text" name="postcode" placeholder="1234AB" required />
                </label>

                <label>
                  <span>Huisnummer</span>
                  <input type="text" name="house_number" placeholder="28" required />
                </label>

                <label>
                  <span>Toevoeging (optioneel)</span>
                  <input type="text" name="suffix" placeholder="1H" />
                </label>

                <div class="row">
                  <button type="submit" class="btn primary">Opslaan</button>
                  <button id="btnVerifyAddress" class="btn outline" type="button">Adres controleren</button>
                </div>

                <div id="addressState" class="small muted"></div>
              </form>
            </div>

            <!-- CHARGERS -->
            <div class="card">
              <h2 style="margin-top:0;">3) Laadpaal</h2>

              <form id="chargerForm" class="form" novalidate>
                <input type="hidden" name="charger_id" />

                <label>
                  <span>Serienummer (verplicht)</span>
                  <input type="text" name="serial_number" placeholder="SN123456" required />
                </label>

                <label>
                  <span>Merk (optioneel)</span>
                  <input type="text" name="brand" placeholder="Alfen / Zaptec / …" />
                </label>

                <label>
                  <span>Model (optioneel)</span>
                  <input type="text" name="model" placeholder="Eve Single Pro-Line / …" />
                </label>

                <label>
                  <span>Vermogen kW (optioneel)</span>
                  <input type="text" name="power_kw" placeholder="11" />
                </label>

                <div class="row">
                  <button type="submit" class="btn primary">Laadpaal opslaan</button>
                  <button id="btnChargerReset" type="button" class="btn outline">Form leegmaken</button>
                </div>

                <div class="small muted">
                  Tip: gebruik exact het serienummer van de laadpaal. Spaties worden automatisch verwijderd.
                </div>
              </form>

              <div style="margin-top:14px;">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Serienummer</th>
                      <th>Merk</th>
                      <th>Model</th>
                      <th class="right">Acties</th>
                    </tr>
                  </thead>
                  <tbody id="chargersTbody">
                    <tr><td colspan="4" class="muted">laden…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- DOCUMENT UPLOAD -->
            <div class="card">
              <h2 style="margin-top:0;">4) Documenten uploaden</h2>
              <div class="muted small">
                Upload je document. We maken eerst een upload-url aan, daarna upload je direct naar opslag.
              </div>

              <form id="uploadForm" class="form" novalidate>
                <label>
                  <span>Type document</span>
                  <select name="doc_type" required>
                    <option value="">Kies…</option>
                    <option value="factuur">Factuur</option>
                    <option value="foto_laadpunt">Foto laadpunt</option>
                    <option value="mandaat">Mandaat</option>
                    <option value="id">ID</option>
                    <option value="kvk">KVK</option>
                    <option value="overig">Overig</option>
                  </select>
                </label>

                <label>
                  <span>Bestand</span>
                  <input type="file" name="file" required />
                </label>

                <button class="btn primary" type="submit">Upload</button>
                <div id="uploadState" class="small muted"></div>
              </form>

              <div style="margin-top:14px;">
                <div class="muted small" style="margin-bottom:8px;">Geüploade documenten</div>
                <div id="docsList" class="small muted">laden…</div>
              </div>
            </div>

            <!-- CONSENTS -->
            <div class="card">
              <h2 style="margin-top:0;">5) Toestemmingen</h2>

              <form id="consentsForm" class="form" novalidate>
                <div class="checkbox-row">
                  <input type="checkbox" id="cTerms" name="terms" />
                  <label for="cTerms">Ik ga akkoord met de voorwaarden</label>
                </div>
                <div class="checkbox-row">
                  <input type="checkbox" id="cPrivacy" name="privacy" />
                  <label for="cPrivacy">Ik ga akkoord met de privacyverklaring</label>
                </div>
                <div class="checkbox-row">
                  <input type="checkbox" id="cMandaat" name="mandaat" />
                  <label for="cMandaat">Ik geef mandaat voor verwerking/inboeking (indien van toepassing)</label>
                </div>

                <button class="btn primary" type="submit">Opslaan</button>
                <div id="consentsState" class="small muted"></div>
              </form>
            </div>

            <!-- STATUS EXPLAIN -->
            <div class="card">
              <h2 style="margin-top:0;">Dossierstatus</h2>
              <div id="statusExplain" class="muted small">laden…</div>
              <div class="row" style="margin-top:10px;">
                <button id="btnEvaluate" class="btn outline" type="button">Herbereken status</button>
              </div>
            </div>
          </div>

          <div style="height:24px;"></div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container footer-inner">
        <p>&copy; <span id="year"></span> Enval. Alle rechten voorbehouden.</p>
      </div>
    </footer>

    <script>
      // ---------------- CONFIG ----------------
      const SUPABASE_URL = "https://yzngrurkpfuqgexbhzgl.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJIUzI1NiIsInJlZiI6Inl6bmdydXJrcGZ1cWdleGJoemdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjYxMjYsImV4cCI6MjA4MDg0MjEyNn0.L7atEcmNvX2Wic0eSM9jWGdFUadIhH21EUFNtzP4YCk";
      const API_BASE = `${SUPABASE_URL}/functions/v1`;

      function edgeHeaders() {
        return {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        };
      }

      function $(id) { return document.getElementById(id); }

      function showToast(message, type = "success") {
        const existing = document.querySelector(".toast");
        if (existing) existing.remove();
        const div = document.createElement("div");
        div.className = `toast toast--${type}`;
        div.textContent = message;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 4200);
      }

      async function apiPost(fnName, body) {
        const res = await fetch(`${API_BASE}/${fnName}`, {
          method: "POST",
          headers: edgeHeaders(),
          body: JSON.stringify(body),
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.ok) {
          const msg = json?.error || `Request failed (${res.status})`;
          throw new Error(msg);
        }
        return json;
      }

      function pillForStatus(status) {
        if (status === "ready_for_booking") return { cls: "pill ok", text: "Klaar voor inboeken" };
        if (status === "ready_for_review") return { cls: "pill warn", text: "Klaar voor review" };
        if (status === "in_review") return { cls: "pill warn", text: "In review" };
        return { cls: "pill", text: "Onvolledig" }; // default for "incomplete" or unknown
      }

      function explainStatus(status) {
        if (status === "ready_for_booking") {
          return "Alles is compleet. Dit dossier kan in principe door naar de volgende stap (inboeken) volgens het proces.";
        }
        if (status === "ready_for_review") {
          return "Alles lijkt compleet, maar moet nog gecontroleerd worden (review).";
        }
        if (status === "in_review") {
          return "Dit dossier staat op review. Je hoeft niets te doen tenzij er om extra info wordt gevraagd.";
        }
        return "Er ontbreken nog onderdelen. Vul de stappen hierboven in.";
      }

      // ---------------- STATE ----------------
      const urlParams = new URLSearchParams(location.search);
      const dossier_id = urlParams.get("d");
      const token = urlParams.get("t");
      const verifyToken = urlParams.get("v"); // optioneel

      let current = null; // dossier-get response

      // ---------------- INIT ----------------
      document.addEventListener("DOMContentLoaded", async () => {
        $("year").textContent = new Date().getFullYear();

        if (!dossier_id || !token) {
          showToast("Ongeldige dossierlink (d/t ontbreekt).", "error");
          $("statusPill").className = "pill err";
          $("statusPill").textContent = "Ongeldige link";
          return;
        }

        $("dossierId").textContent = dossier_id;

        $("btnRefresh").addEventListener("click", () => reloadAll());
        $("btnEvaluate").addEventListener("click", () => evaluateAndRender());

        $("btnEmailVerifyStart").addEventListener("click", async () => {
          try {
            $("emailState").textContent = "Bevestigingsmail wordt verstuurd…";
            await apiPost("api-dossier-email-verify-start", { dossier_id, token });
            $("emailState").textContent = "Bevestigingsmail verstuurd. Check je inbox.";
            showToast("Bevestigingsmail verstuurd.", "success");
          } catch (e) {
            $("emailState").textContent = e.message;
            showToast(e.message, "error");
          }
        });

        $("addressForm").addEventListener("submit", onAddressSave);
        $("btnVerifyAddress").addEventListener("click", onAddressVerify);

        $("chargerForm").addEventListener("submit", onChargerSave);
        $("btnChargerReset").addEventListener("click", () => {
          $("chargerForm").reset();
          $("chargerForm").querySelector('[name="charger_id"]').value = "";
        });

        $("uploadForm").addEventListener("submit", onUpload);
        $("consentsForm").addEventListener("submit", onConsentsSave);

        await reloadAll();

        // Als v aanwezig is: probeer email-verify-complete (1x)
        if (verifyToken) {
          try {
            await apiPost("api-dossier-email-verify-complete", { dossier_id, token, verify_token: verifyToken });
            // remove v from url (clean)
            const cleanUrl = new URL(location.href);
            cleanUrl.searchParams.delete("v");
            history.replaceState({}, "", cleanUrl.toString());
            showToast("E-mail bevestigd.", "success");
            await reloadAll();
          } catch (e) {
            showToast(e.message, "error");
          }
        }
      });

      // ---------------- LOADERS ----------------
      async function reloadAll() {
        try {
          $("statusPill").textContent = "laden…";
          current = await apiPost("api-dossier-get", { dossier_id, token });
          renderAll();
          await evaluateAndRender(); // één keer, centraal
        } catch (e) {
          showToast(e.message, "error");
          $("statusPill").className = "pill err";
          $("statusPill").textContent = "Fout";
        }
      }

      async function evaluateAndRender() {
        try {
          // Alleen callen als function bestaat (jij hebt hem)
          const ev = await apiPost("api-dossier-evaluate", { dossier_id, token });
          // daarna opnieuw dossier ophalen om status en checks consistent te hebben
          current = await apiPost("api-dossier-get", { dossier_id, token });
          renderStatus();
          renderChecks();
          renderEmailState();
          renderAddressState();
          renderChargers();
          renderDocs();
          renderConsents();
          return ev;
        } catch (e) {
          // evaluator kan falen zonder dat dossier kapot is; toon fout maar laat UI staan
          renderStatus();
          $("statusExplain").textContent = `Status niet te herberekenen: ${e.message}`;
        }
      }

      // ---------------- RENDER ----------------
      function renderAll() {
        renderStatus();
        renderChecks();
        renderEmailState();
        renderAddressState();
        renderChargers();
        renderDocs();
        renderConsents();
      }

      function renderStatus() {
        const status = current?.dossier?.status || "incomplete";
        const p = pillForStatus(status);
        $("statusPill").className = p.cls;
        $("statusPill").textContent = p.text;
        $("statusExplain").textContent = explainStatus(status);
      }

      function renderChecks() {
        // optioneel: toon niets fancy; evaluator schrijft checks
        const checks = current?.checks || [];
        if (!checks.length) return;
      }

      function renderEmailState() {
        const d = current?.dossier || {};
        if (d.email_verified_at) {
          $("emailState").innerHTML = `✅ Bevestigd op <span class="mono">${d.email_verified_at}</span>`;
        } else if (d.email_verification_sent_at) {
          $("emailState").innerHTML = `⏳ Nog niet bevestigd. Mail verstuurd op <span class="mono">${d.email_verification_sent_at}</span>`;
        } else {
          $("emailState").textContent = "Nog niet bevestigd.";
        }
      }

      function renderAddressState() {
        const d = current?.dossier || {};
        const parts = [];
        if (d.address_postcode) parts.push(d.address_postcode);
        if (d.address_house_number) parts.push(d.address_house_number + (d.address_suffix ? d.address_suffix : ""));
        const entered = parts.length ? parts.join(" ") : "—";

        const verified = d.address_verified_at ? `✅ gecontroleerd: ${d.address_verified_at}` : "⏳ nog niet gecontroleerd";
        const resolved = (d.address_street || d.address_city) ? `→ ${d.address_street || ""} ${d.address_city || ""}` : "";

        $("addressState").textContent = `Ingevuld: ${entered} | ${verified} ${resolved}`.trim();

        // prefills
        const f = $("addressForm");
        f.querySelector('[name="postcode"]').value = d.address_postcode || "";
        f.querySelector('[name="house_number"]').value = d.address_house_number || "";
        f.querySelector('[name="suffix"]').value = d.address_suffix || "";
      }

      function renderChargers() {
        const tbody = $("chargersTbody");
        const chargers = current?.chargers || [];

        if (!chargers.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="muted">Nog geen laadpalen toegevoegd.</td></tr>`;
          return;
        }

        tbody.innerHTML = chargers.map(c => {
          const brand = c.brand || "-";
          const model = c.model || "-";
          return `
            <tr>
              <td class="mono">${c.serial_number}</td>
              <td>${escapeHtml(brand)}</td>
              <td>${escapeHtml(model)}</td>
              <td class="right">
                <button class="btn outline small" type="button" data-act="edit" data-id="${c.id}">Bewerk</button>
                <button class="btn outline small" type="button" data-act="del" data-id="${c.id}">Verwijder</button>
              </td>
            </tr>
          `;
        }).join("");

        tbody.querySelectorAll("button[data-act='edit']").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const c = chargers.find(x => String(x.id) === String(id));
            if (!c) return;
            const f = $("chargerForm");
            f.querySelector('[name="charger_id"]').value = c.id;
            f.querySelector('[name="serial_number"]').value = c.serial_number || "";
            f.querySelector('[name="brand"]').value = c.brand || "";
            f.querySelector('[name="model"]').value = c.model || "";
            f.querySelector('[name="power_kw"]').value = (c.power_kw ?? "") + "";
            window.scrollTo({ top: f.getBoundingClientRect().top + window.scrollY - 90, behavior: "smooth" });
          });
        });

        tbody.querySelectorAll("button[data-act='del']").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Weet je zeker dat je deze laadpaal wilt verwijderen?")) return;
            try {
              await apiPost("api-dossier-charger-delete", { dossier_id, token, charger_id: id });
              showToast("Laadpaal verwijderd.", "success");
              await reloadAll();
            } catch (e) {
              showToast(e.message, "error");
            }
          });
        });
      }

      function renderDocs() {
        const docs = current?.documents || [];
        if (!docs.length) {
          $("docsList").textContent = "Nog geen documenten geüpload.";
          return;
        }
        $("docsList").innerHTML = docs.map(d => {
          const dt = d.doc_type || "-";
          const fn = d.filename || "-";
          const when = d.created_at ? d.created_at : "";
          return `• ${escapeHtml(dt)} – ${escapeHtml(fn)} <span class="muted small mono">${escapeHtml(when)}</span><br/>`;
        }).join("");
      }

      function renderConsents() {
        const cons = current?.consents || [];
        const latest = {};
        for (const c of cons) {
          // neem newest per type (cons is al desc in get)
          if (!latest[c.consent_type]) latest[c.consent_type] = c;
        }
        $("cTerms").checked = latest["terms"]?.accepted === true;
        $("cPrivacy").checked = latest["privacy"]?.accepted === true;
        $("cMandaat").checked = latest["mandaat"]?.accepted === true;
      }

      // ---------------- ACTIONS ----------------
      async function onAddressSave(e) {
        e.preventDefault();
        const f = e.target;
        const postcode = f.querySelector('[name="postcode"]').value.trim();
        const house_number = f.querySelector('[name="house_number"]').value.trim();
        const suffix = f.querySelector('[name="suffix"]').value.trim();

        try {
          $("addressState").textContent = "Opslaan…";
          await apiPost("api-dossier-address-save", { dossier_id, token, postcode, house_number, suffix });
          showToast("Adres opgeslagen.", "success");
          await reloadAll();
        } catch (e) {
          $("addressState").textContent = e.message;
          showToast(e.message, "error");
        }
      }

      async function onAddressVerify() {
        try {
          $("addressState").textContent = "Adres controleren…";
          await apiPost("api-dossier-address-verify", { dossier_id, token });
          showToast("Adres gecontroleerd.", "success");
          await reloadAll();
        } catch (e) {
          $("addressState").textContent = e.message;
          showToast(e.message, "error");
        }
      }

      async function onChargerSave(e) {
        e.preventDefault();
        const f = e.target;

        const charger_id = f.querySelector('[name="charger_id"]').value || null;
        const serial_number = (f.querySelector('[name="serial_number"]').value || "").trim();
        const brand = (f.querySelector('[name="brand"]').value || "").trim();
        const model = (f.querySelector('[name="model"]').value || "").trim();
        const power_kw_raw = (f.querySelector('[name="power_kw"]').value || "").trim();

        const power_kw = power_kw_raw ? Number(power_kw_raw.replace(",", ".")) : null;

        try {
          await apiPost("api-dossier-charger-save", {
            dossier_id,
            token,
            charger_id,
            serial_number,
            brand,
            model,
            power_kw,
          });

          showToast("Laadpaal opgeslagen.", "success");
          f.reset();
          f.querySelector('[name="charger_id"]').value = "";
          await reloadAll();
        } catch (e) {
          showToast(e.message, "error");
        }
      }

      async function onConsentsSave(e) {
        e.preventDefault();
        try {
          $("consentsState").textContent = "Opslaan…";
          const consents = {
            terms: $("cTerms").checked,
            privacy: $("cPrivacy").checked,
            mandaat: $("cMandaat").checked,
          };
          await apiPost("api-dossier-consents-save", { dossier_id, token, consents });
          $("consentsState").textContent = "Opgeslagen.";
          showToast("Toestemmingen opgeslagen.", "success");
          await reloadAll();
        } catch (e) {
          $("consentsState").textContent = e.message;
          showToast(e.message, "error");
        }
      }

      async function onUpload(e) {
        e.preventDefault();
        const f = e.target;
        const doc_type = f.querySelector('[name="doc_type"]').value;
        const fileInput = f.querySelector('[name="file"]');
        const file = fileInput.files && fileInput.files[0];

        if (!doc_type) { showToast("Kies documenttype.", "error"); return; }
        if (!file) { showToast("Kies bestand.", "error"); return; }

        try {
          $("uploadState").textContent = "Upload voorbereiden…";

          const meta = await apiPost("api-dossier-upload-url", {
            dossier_id,
            token,
            doc_type,
            filename: file.name,
            content_type: file.type || "application/octet-stream",
            size_bytes: file.size,
          });

          $("uploadState").textContent = "Uploaden…";

          // signed_url is a signed upload URL (Supabase signed upload)
          const putRes = await fetch(meta.signed_url, {
            method: "PUT",
            headers: { "Content-Type": file.type || "application/octet-stream" },
            body: file,
          });

          if (!putRes.ok) {
            const t = await putRes.text().catch(() => "");
            throw new Error(`Upload failed: ${putRes.status} ${t}`.slice(0, 200));
          }

          $("uploadState").textContent = "Geüpload.";
          showToast("Upload gelukt.", "success");
          f.reset();
          await reloadAll();
        } catch (e) {
          $("uploadState").textContent = e.message;
          showToast(e.message, "error");
        }
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
